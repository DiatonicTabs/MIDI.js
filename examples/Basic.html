<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8"/>

		<!-- shims -->
		<script src="../inc/shim/Base64.js"></script>
		<script src="../inc/shim/WebAudioAPI.js"></script>
		<script src="../inc/shim/WebMIDIAPI.js"></script>

		<!-- utils -->
		<script src="../inc/dom/request_script.js"></script>
		<script src="../inc/dom/request_xhr.js"></script>
		<!--<script src="../inc/EventEmitter.js"></script>-->

		<script src="https://polyfill.io/v2/polyfill.js"></script>
		<script src="../dist/MIDI.js"></script>

	</head>
	<body>
		<pre id="jobs"></pre>
		<script>
			window.onload = function () {
//				MIDI.AudioTag.connect()
				MIDI.autoconnect()
				MIDI.channels = 1

				MIDI.programs.load({
					programID: 0,
//					program: './soundfont/acoustic_grand_piano2-mp3.json'
					program: "./soundfont/synth_drum-mp3.json",
				})

				MIDI.jobs.wait().then(function () {
					let speed = 2
					function play() {
						let i
						for (i = 0; i < 8; i += 1) {
							const note = "A" + i
							const startTime = MIDI.currentTime
							MIDI.noteOff(0, note)
							MIDI.noteOn(0, note, 127, startTime + (i / speed))
						}

						if(speed < 32) {
							speed *= 2
							setTimeout(play, (i / speed) * 1000)
						}
					}

					play()
				}).catch(function (error) {
					console.log("Failed:", error)
					document.body.style.backgroundColor = "red"
				})
			}
		</script>
	</body>
</html>