<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8"/>

		<!-- shims -->
		<script src="../inc/shim/Base64.js"></script>
		<script src="../inc/shim/WebAudioAPI.js"></script>
		<script src="../inc/shim/WebMIDIAPI.js"></script>

		<!-- utils -->
		<script src="../inc/dom/request_script.js"></script>
		<script src="../inc/dom/request_xhr.js"></script>
		<script src="../inc/EventEmitter.js"></script>

		<script src="https://wzrd.in/standalone/tunajs@latest"></script>
		<script src="../build/MIDI.js"></script>

	</head>
	<body>
		<script>

			window.onload = function () {
				MIDI.startDebugging()
				MIDI.autoselectFormat()
				MIDI.connect(new MIDI.WebAudio())
				MIDI.setChannels(1)

				MIDI.onProgress = function (state, progress) {
					console.log('Loading:', progress.toFixed(2), '%')
				}

				MIDI.loadProgram({
					programID: 0,
					filename: './soundfont/soundDB.json'
				})

				MIDI.volume = 127
				MIDI.jobs.waitForActiveJobs().then(function () {
					console.log('Ready to play!')
					var time = MIDI.currentTime + 1
					//					for(let j = 0; j < 10; j += 1) {
					//						for (let i = 0; i < 10; i += 1) {
					//							console.log(MIDI.currentTime)
					//							MIDI.noteOn(1, piano + i + 2, velocity, time += 0.1)
					//							MIDI.noteOff(1, piano + i + 2, time + 0.4)
					//						}
					//						time += 1
					//
					//						if(j === 5) {
					//							MIDI.channels[1].programID = 10
					//						}
					//					}

					let active = false
					const note = 'B0'
					window.addEventListener('mousedown', function () {
						MIDI.noteOn(0, note)
						active = true
					})

					let muteTimer
					window.addEventListener('mousemove', function (e) {
						clearTimeout(muteTimer)
						if (active) {
							MIDI.channels[0].volume = 127
							muteTimer = setTimeout(() => MIDI.channels[0].volume = 0, 200)
						}
					})

					window.addEventListener('mouseup', function () {
						MIDI.noteOff(0, note)
						active = false
					})

					//						MIDI.noteOff(1, 'A0', time + 100)

					//					var startTime = MIDI.currentTime, note, velocity = 127;
					//
					//					for (note = 50; note < 58; ++note) {
					//						MIDI.noteOn(0, note, velocity, startTime)
					//						MIDI.noteOff(0, note, startTime + 0.2)
					//						++startTime
					//					}
					//
					//					setTimeout(function () {
					//						startTime = MIDI.currentTime
					//						for (var note = 58; note < 67; ++note) {
					//							MIDI.noteOn(0, note, velocity, startTime)
					//							MIDI.noteOff(0, note, startTime + 0.2)
					//							++startTime
					//						}
					//					}, 4500)

				})
			}

		</script>
	</body>
</html>