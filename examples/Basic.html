<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8"/>

		<!-- shims -->
		<script src="../inc/shim/Base64.js"></script>
		<script src="../inc/shim/WebAudioAPI.js"></script>
		<script src="../inc/shim/WebMIDIAPI.js"></script>

		<!-- utils -->
		<script src="../inc/dom/request_script.js"></script>
		<script src="../inc/dom/request_xhr.js"></script>
		<script src="../inc/EventEmitter.js"></script>

		<script src="https://wzrd.in/standalone/tunajs@latest"></script>
		<script src="../build/MIDI.js"></script>

	</head>
	<body>
		<script>
			window.onload = function () {
				MIDI.startDebugging()
				MIDI.autoselectFormat()

				const controller = new MIDI.controllers.SoundBoard({
					brush_stroke: {
						note: 'B0',
						requiresInteraction: true,
						maxSimultaneous: 1
					}
				})
				const soundModule = new MIDI.soundModules.WebAudio()
				controller.connect(soundModule)
				controller.setChannels(1)

				MIDI.onProgress = function (state, progress) {
					console.log('Loading:', progress.toFixed(2), '%')
				}

				MIDI.loadProgram({
					programID: 0,
					program: './soundfont/soundDB.json'
				})

				MIDI.volume = 127
				MIDI.jobs.waitForActiveJobs().then(function () {
					console.log('Ready to play!')
					var time = MIDI.currentTime + 1

					let active = false
					window.addEventListener('mousedown', function () {
						controller.press('brush_stroke')
						active = true
					})

					let muteTimer
					window.addEventListener('mousemove', function (e) {
						controller.startInteractingWith('brush_stroke')
						//						const noteInfo = MIDI.programs[0].notes[note]
						clearTimeout(muteTimer)
						if (active) {
							//							controller.channels[0].volume = 127
							muteTimer = setTimeout(() => controller.stopInteractingWith('brush_stroke'), 300)
						}
					})

					window.addEventListener('mouseup', function () {
						//						controller.noteOff(0, note)
						//						controller.channels[0].volume = 127
						controller.release('brush_stroke')
						active = false
					})
				})
			}

		</script>
	</body>
</html>